name: Build JNI Library for Android (NDK r26d)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 15

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download and Setup Android NDK r26d
      run: |
        $url = "https://dl.google.com/android/repository/android-ndk-r26d-windows.zip"
        $output = "${{ github.workspace }}\\android-ndk.zip"
        Invoke-WebRequest -Uri $url -OutFile $output
        Expand-Archive -Path $output -DestinationPath "${{ github.workspace }}"
        $ndkPath = "${{ github.workspace }}\\android-ndk-r26d"
        echo "NDK_HOME=$ndkPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        echo "NDK_ROOT=$ndkPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      shell: pwsh

    - name: Build with ndk-build
      id: build
      run: |
        cd jni
        & "${{ github.workspace }}\\android-ndk-r26d\\ndk-build.cmd" -j4
        
        # Проверяем, создались ли .so файлы
        if (Test-Path "libs") {
          $soCount = (Get-ChildItem -Path "libs" -Recurse -Filter "*.so" | Measure-Object).Count
          echo "Found $soCount .so files"
          echo "HAS_SO_FILES=true" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        } else {
          echo "No libs folder created"
          echo "HAS_SO_FILES=false" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          exit 1
        }
      shell: pwsh

    - name: List output files
      if: env.HAS_SO_FILES == 'true'
      run: |
        dir /s *.so
      shell: cmd
      
    - name: Create ZIP archive
      if: env.HAS_SO_FILES == 'true'
      id: create_zip
      run: |
        $zipPath = "artifacts.zip"
        
        # Создаем архив только если есть файлы
        $soFiles = Get-ChildItem -Path "jni\libs" -Recurse -Filter "*.so"
        
        if ($soFiles.Count -gt 0) {
          # Создаем временную папку для архивации
          $tempDir = "temp_artifacts"
          New-Item -ItemType Directory -Path $tempDir -Force
          
          # Копируем все .so файлы с сохранением структуры папок
          foreach ($file in $soFiles) {
            $relativePath = $file.FullName.Substring((Resolve-Path "jni\libs").Path.Length + 1)
            $destPath = Join-Path $tempDir $relativePath
            $destDir = [System.IO.Path]::GetDirectoryName($destPath)
            New-Item -ItemType Directory -Path $destDir -Force
            Copy-Item $file.FullName -Destination $destPath
          }
          
          # Создаем ZIP архив
          Compress-Archive -Path "$tempDir\*" -DestinationPath $zipPath -Force
          
          # Удаляем временную папку
          Remove-Item -Path $tempDir -Recurse -Force
          
          # Проверяем размер архива
          $fileSize = (Get-Item $zipPath).Length
          echo "ZIP file size: $fileSize bytes"
          echo "ARTIFACT_PATH=$zipPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          
          if ($fileSize -eq 0) {
            echo "ERROR: Created empty ZIP archive"
            exit 1
          }
        } else {
          echo "ERROR: No .so files found to archive"
          exit 1
        }
      shell: pwsh

    - name: Upload artifacts
      if: env.HAS_SO_FILES == 'true' && steps.create_zip.conclusion == 'success'
      uses: actions/upload-artifact@v4
      with:
        name: compiled-libraries
        path: ${{ env.ARTIFACT_PATH || 'artifacts.zip' }}
        retention-days: 1