name: Build JNI Library for Android (NDK r21e)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 15

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Cache Android NDK
      id: cache-ndk
      uses: actions/cache@v4
      with:
        path: ${{ github.workspace }}\android-ndk-r21e
        key: ${{ runner.os }}-ndk-r21e-${{ hashFiles('jni/Android.mk', 'jni/Application.mk') }}
        restore-keys: |
          ${{ runner.os }}-ndk-r21e-

    - name: Setup Android NDK r21e
      if: steps.cache-ndk.outputs.cache-hit != 'true'
      run: |
        $ndkVersion = "r21e"
        $ndkPath = "${{ github.workspace }}\android-ndk-$ndkVersion"
        $ndkZipPath = "${{ github.workspace }}\android-ndk.zip"
        
        $url = "https://dl.google.com/android/repository/android-ndk-$ndkVersion-windows-x86_64.zip"
        Invoke-WebRequest -Uri $url -OutFile $ndkZipPath
        Expand-Archive -Path $ndkZipPath -DestinationPath "${{ github.workspace }}"
        Remove-Item -Path $ndkZipPath -Force
        
        echo "NDK_HOME=$ndkPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        echo "NDK_ROOT=$ndkPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      shell: pwsh

    - name: Set NDK environment variables
      if: steps.cache-ndk.outputs.cache-hit == 'true'
      run: |
        $ndkPath = "${{ github.workspace }}\android-ndk-r21e"
        echo "NDK_HOME=$ndkPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        echo "NDK_ROOT=$ndkPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      shell: pwsh

    - name: Build with ndk-build
      id: build
      run: |
        cd jni
        & "${{ github.workspace }}\android-ndk-r21e\ndk-build.cmd" -j%NUMBER_OF_PROCESSORS%
        
        if (Test-Path "libs") {
          $soCount = (Get-ChildItem -Path "libs" -Recurse -Filter "*.so" | Measure-Object).Count
          echo "HAS_SO_FILES=true" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        } else {
          echo "HAS_SO_FILES=false" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          exit 1
        }
      shell: pwsh

    - name: List output files
      if: env.HAS_SO_FILES == 'true'
      run: |
        dir /s *.so
      shell: cmd
      
    - name: Create ZIP archive
      if: env.HAS_SO_FILES == 'true'
      id: create_zip
      run: |
        $zipPath = "artifacts.zip"
        $soFiles = Get-ChildItem -Path "jni\libs" -Recurse -Filter "*.so"
        
        if ($soFiles.Count -gt 0) {
          $tempDir = "temp_artifacts"
          New-Item -ItemType Directory -Path $tempDir -Force
          
          foreach ($file in $soFiles) {
            $relativePath = $file.FullName.Substring((Resolve-Path "jni\libs").Path.Length + 1)
            $destPath = Join-Path $tempDir $relativePath
            $destDir = [System.IO.Path]::GetDirectoryName($destPath)
            New-Item -ItemType Directory -Path $destDir -Force
            Copy-Item $file.FullName -Destination $destPath
          }
          
          Compress-Archive -Path "$tempDir\*" -DestinationPath $zipPath -Force
          Remove-Item -Path $tempDir -Recurse -Force
          $fileSize = (Get-Item $zipPath).Length
          echo "ARTIFACT_PATH=$zipPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          
          if ($fileSize -eq 0) {
            exit 1
          }
        } else {
          exit 1
        }
      shell: pwsh

    - name: Upload artifacts
      if: env.HAS_SO_FILES == 'true' && steps.create_zip.conclusion == 'success'
      uses: actions/upload-artifact@v4
      with:
        name: compiled-libraries
        path: ${{ env.ARTIFACT_PATH || 'artifacts.zip' }}
        retention-days: 1